// Test: Query with Source block syntax (the transform path)
//
// This tests the ~query { SQL } syntax which goes through the transform,
// unlike query.literal which is a runtime event.

~import "$libs/sqlite3"
~import "$std/io"

~libs.sqlite3:open(path: ":memory:")
| db d |> libs.sqlite3:exec(d.conn, "CREATE TABLE users (id INTEGER, name TEXT)")
    | ok |> libs.sqlite3:exec(d.conn, "INSERT INTO users VALUES (42, 'Alice')")
        | ok |> libs.sqlite3:query(conn: d.conn) [SQL]{
                SELECT * FROM users
            }
            | row _ |> std.io:print.ln("Found row via transform!")
            | empty |> std.io:print.ln("No rows")
            | err _ |> std.io:print.ln("Query error")
        | err _ |> std.io:print.ln("Insert error")
    | err _ |> std.io:print.ln("Create error")
| err _ |> std.io:print.ln("Open error")
